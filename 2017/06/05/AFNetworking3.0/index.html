<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>AFNetworking3.0 | 向着阳光奔跑</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="研究AFNetworking框架。">
<meta property="og:type" content="article">
<meta property="og:title" content="AFNetworking3.0">
<meta property="og:url" content="http://peilinghui.com/2017/06/05/AFNetworking3.0/index.html">
<meta property="og:site_name" content="向着阳光奔跑">
<meta property="og:description" content="研究AFNetworking框架。">
<meta property="og:updated_time" content="2018-07-18T01:34:43.130Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AFNetworking3.0">
<meta name="twitter:description" content="研究AFNetworking框架。">
  
    <link rel="alternative" href="/atom.xml" title="向着阳光奔跑" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false,
      }
  </script>

  
      <script>
          yiliaConfig.rootUrl = "/";
      </script>
  

  
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/images/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">向阳</a></h1>
        </hgroup>

        
        <p class="header-subtitle">没有到不了的远方</p>
        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="/peilinghuibest@gmail.com" title="Email"></a></li>
                            
                                <li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/575544059" title="新浪微博"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/peilinghui" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://lysongzi.com/">小松子</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/CHENYUFENG1991/article/category/5655903/4">iOS大神</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://cspilgrimzww.github.io/">蔚蔚</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.changhuiyuan.com/">惠源</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.hxdavid.com/">PAT大神</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://wut0719.github.io/">桐神</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://pangjiuzala.github.io/">兴爷</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://han.pm/">交换生</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://frankhu.me">frank</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://judyzhangxin.com/">UI设计师</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://sunus.me/">阿里学长</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://imhuchao.com/">胡超-凤凰网</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.xuanzhangjiong.xyz/">囧囧囧-网易安卓</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">没有到不了的远方，向往远方。。</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">向阳</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/images/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">向阳</a></h1>
            </hgroup>
            
            <p class="header-subtitle">没有到不了的远方</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="/peilinghuibest@gmail.com" title="Email"></a></li>
                            
                                <li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/575544059" title="新浪微博"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/peilinghui" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-AFNetworking3.0" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/05/AFNetworking3.0/" class="article-date">
      <time datetime="2017-06-05T06:08:53.000Z" itemprop="datePublished">2017-06-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      AFNetworking3.0
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>研究AFNetworking框架。<br><a id="more"></a></p>
<h1 id="AFNetworking3-0"><a href="#AFNetworking3-0" class="headerlink" title="AFNetworking3.0"></a>AFNetworking3.0</h1><h1 id="NSURLSession"><a href="#NSURLSession" class="headerlink" title="NSURLSession"></a>NSURLSession</h1><h2 id="AFNHTTPSessionManager"><a href="#AFNHTTPSessionManager" class="headerlink" title="AFNHTTPSessionManager"></a>AFNHTTPSessionManager</h2><p><code>AFHTTPSessionManager</code> is a subclass of <code>AFURLSessionManager</code> with convenience methods for making HTTP requests. When a <code>baseURL</code> is provided, requests made with the <code>GET</code> / <code>POST</code> / et al. convenience methods can be made with relative paths.</p>
<h3 id="在-h文件中"><a href="#在-h文件中" class="headerlink" title="在.h文件中"></a>在.h文件中</h3><p>遵守NSSecureCoding, NSCopying协议</p>
<h4 id="定义属性"><a href="#定义属性" class="headerlink" title="定义属性"></a>定义属性</h4><p>baseURL(NSURL)，requestSerializer(AFHTTPRequestSerializer)，responseSerializer(AFHTTPResponseSerializer)。</p>
<ol>
<li><p>初始化方法：<br><code>+ (instancetype)manager;</code><br><code>- (instancetype)initWithBaseURL:(nullable NSURL *)url;</code><br>`- (instancetype)initWithBaseURL:(nullable NSURL *)url</p>
<pre><code>sessionConfiguration:(nullable NSURLSessionConfiguration *)configuration NS_DESIGNATED_INITIALIZER;`
</code></pre></li>
<li><p>创建HTTP请求<br>主要是发送GET，POST(有无下载，downloadProgress是在Session queue中，不在主队列)，HEAD，PUT，PATCH，DELETE。</p>
</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (nullable <span class="built_in">NSURLSessionDataTask</span> *)GET:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                            parameters:(nullable <span class="keyword">id</span>)parameters</span><br><span class="line">                              progress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress))downloadProgress</span><br><span class="line">                               success:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *task, <span class="keyword">id</span> _Nullable responseObject))success</span><br><span class="line">                               failure:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> * _Nullable task, <span class="built_in">NSError</span> *error))failure;</span><br></pre></td></tr></table></figure>
<p>只有POST请求有多种，需要加<code>constructingBodyWithBlock:(nullable void (^)(id &lt;AFMultipartFormData&gt; formData))block</code>将一个参数和拼接数据到HTTP主体。该block参数是采用<code>AFMultipartFormData</code>协议的对象。</p>
<h3 id="在-m文件中"><a href="#在-m文件中" class="headerlink" title="在.m文件中"></a>在.m文件中</h3><p>主要是方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithHTTPMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                       URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                      parameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                  uploadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgress</span><br><span class="line">                                downloadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgress</span><br><span class="line">                                         success:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *, <span class="keyword">id</span>))success</span><br><span class="line">                                         failure:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *, <span class="built_in">NSError</span> *))failure</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="keyword">self</span><span class="variable">.requestSerializer</span> requestWithMethod:method URLString:[[<span class="built_in">NSURL</span> URLWithString:URLString relativeToURL:<span class="keyword">self</span><span class="variable">.baseURL</span>] absoluteString] parameters:parameters error:&amp;serializationError];</span><br><span class="line">    <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">        <span class="keyword">if</span> (failure) &#123;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(<span class="keyword">self</span><span class="variable">.completionQueue</span> ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                failure(<span class="literal">nil</span>, serializationError);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</span><br><span class="line">    dataTask = [<span class="keyword">self</span> dataTaskWithRequest:request</span><br><span class="line">                          uploadProgress:uploadProgress</span><br><span class="line">                        downloadProgress:downloadProgress</span><br><span class="line">                       completionHandler:^(<span class="built_in">NSURLResponse</span> * __unused response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="keyword">if</span> (failure) &#123;</span><br><span class="line">                failure(dataTask, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                success(dataTask, responseObject);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有的网络请求都调用dataTaskWithHTTPMethod这个方法来实现。<br>实现了：</p>
<ol>
<li>NSObject中的description方法来打印出BaseURL，session，和operationQueue。</li>
<li>NSSecureCoding中的supportsSecureCoding，initWithCoder，encodeWithCoder方法。</li>
<li>NSCopying中的copyWithZone方法（HTTPClient）</li>
</ol>
<h2 id="AFURLSessionManager"><a href="#AFURLSessionManager" class="headerlink" title="AFURLSessionManager"></a>AFURLSessionManager</h2><p><code>AFURLSessionManager</code>创建和管理一个 <code>NSURLSession</code> 对象根据一个特殊的 <code>NSURLSessionConfiguration</code> 对象, 它符合<code>&lt;NSURLSessionTaskDelegate&gt;</code>, <code>&lt;NSURLSessionDataDelegate&gt;</code>, <code>&lt;NSURLSessionDownloadDelegate&gt;</code>, and <code>&lt;NSURLSessionDelegate&gt;</code>.</p>
<h3 id="NSURLSession-amp-NSURLSessionTask-Delegate-Methods："><a href="#NSURLSession-amp-NSURLSessionTask-Delegate-Methods：" class="headerlink" title="NSURLSession &amp; NSURLSessionTask Delegate Methods："></a><strong>NSURLSession &amp; NSURLSessionTask Delegate Methods：</strong></h3><h4 id="NSURLSessionDelegate"><a href="#NSURLSessionDelegate" class="headerlink" title="NSURLSessionDelegate"></a>NSURLSessionDelegate</h4><p><code>- URLSession:didBecomeInvalidWithError:</code><br><code>- URLSession:didReceiveChallenge:completionHandler:</code><br> <code>- URLSessionDidFinishEventsForBackgroundURLSession:</code></p>
<h4 id="NSURLSessionTaskDelegate"><a href="#NSURLSessionTaskDelegate" class="headerlink" title="NSURLSessionTaskDelegate"></a>NSURLSessionTaskDelegate</h4><p><code>-URLSession:willPerformHTTPRedirection:newRequest:completionHandler:</code><br><code>- URLSession:task:didReceiveChallenge:completionHandler:</code><br><code>-URLSession:task:didSendBodyData:totalBytesSent:totalBytesExpectedToSend:</code><br><code>- URLSession:task:needNewBodyStream:</code><br><code>- URLSession:task:didCompleteWithError:</code></p>
<h4 id="NSURLSessionDataDelegate"><a href="#NSURLSessionDataDelegate" class="headerlink" title="NSURLSessionDataDelegate"></a>NSURLSessionDataDelegate</h4><p><code>URLSession:dataTask:didReceiveResponse:completionHandler:</code><br><code>URLSession:dataTask:didBecomeDownloadTask:</code><br><code>URLSession:dataTask:didReceiveData:</code><br><code>URLSession:dataTask:willCacheResponse:completionHandler:</code></p>
<h4 id="NSURLSessionDownloadDelegate"><a href="#NSURLSessionDownloadDelegate" class="headerlink" title="NSURLSessionDownloadDelegate"></a>NSURLSessionDownloadDelegate</h4><p><code>URLSession:downloadTask:didFinishDownloadingToURL:</code><br><code>URLSession:downloadTask:didWriteData:totalBytesWritten:totalBytesWritten:totalBytesExpectedToWrite:</code><br><code>URLSession:downloadTask:didResumeAtOffset:expectedTotalBytes:</code></p>
<h3 id="在-h文件中-1"><a href="#在-h文件中-1" class="headerlink" title="在.h文件中"></a>在.h文件中</h3><p>遵守协议protocol为 <nsurlsessiondelegate, nsurlsessiontaskdelegate,="" nsurlsessiondatadelegate,="" nsurlsessiondownloaddelegate,="" nssecurecoding,="" nscopying="">，对应相应的代理方法。</nsurlsessiondelegate,></p>
<h4 id="定义属性-1"><a href="#定义属性-1" class="headerlink" title="定义属性"></a>定义属性</h4><ol>
<li>session(NSURLSession),operationQueue(NSOperationQueue).responseSerializer(AFURLResponseSerialization)。</li>
<li>管理安全的策略：securityPolicy(AFSecurityPolicy).</li>
<li>管理检测网络的连通性：reachabilityManager(AFNetworkReachabilityManager).</li>
<li>获得 Session Tasks：tasks，dataTasks,uploadTasks,downloadTasks.</li>
<li>管理回调的队列：<br>completionQueue(dispatch_queue_t),completionGroup(dispatch_group_t).</li>
</ol>
<h4 id="定义方法："><a href="#定义方法：" class="headerlink" title="定义方法："></a>定义方法：</h4><ol>
<li><p>初始化方法：<br><code>- (instancetype)initWithSessionConfiguration:(nullable NSURLSessionConfiguration *)configuration;</code><br><code>- (void)invalidateSessionCancelingTasks:(BOOL)cancelPendingTasks;</code></p>
</li>
<li><p>运行Data Tasks:<br>`- (NSURLSessionDataTask <em>)dataTaskWithRequest:(NSURLRequest </em>)request</p>
<pre><code>   uploadProgress:(nullable void (^)(NSProgress *uploadProgress))uploadProgressBlock
 downloadProgress:(nullable void (^)(NSProgress *downloadProgress))downloadProgressBlock
completionHandler:(nullable void (^)(NSURLResponse *response, id _Nullable responseObject,  NSError * _Nullable error))completionHandler;
</code></pre><p>`</p>
</li>
<li>运行上传任务：<br>`- (NSURLSessionUploadTask <em>)uploadTaskWithRequest:(NSURLRequest </em>)request<pre><code>         fromFile:(NSURL *)fileURL
         progress:(nullable void (^)(NSProgress *uploadProgress))uploadProgressBlock
completionHandler:(nullable void (^)(NSURLResponse *response, id _Nullable responseObject, NSError  * _Nullable error))completionHandler;`
</code></pre></li>
<li>运行下载任务：<br>`- (NSURLSessionDownloadTask <em>)downloadTaskWithRequest:(NSURLRequest </em>)request<pre><code>         progress:(nullable void (^)(NSProgress *downloadProgress))downloadProgressBlock
      destination:(nullable NSURL * (^)(NSURL *targetPath, NSURLResponse *response))destination
completionHandler:(nullable void (^)(NSURLResponse *response, NSURL * _Nullable filePath, NSError * _Nullable error))completionHandler;`
</code></pre>还有就是把NSURLRequest替换成NSData,</li>
<li>获取任务的进程(Getting Progress for Tasks)：<br><code>- (nullable NSProgress *)uploadProgressForTask:(NSURLSessionTask *)task;</code>还有downloadProgressForTask</li>
<li>设置Session的代理回调<br><code>- (void)setSessionDidBecomeInvalidBlock:(nullable void (^)(NSURLSession *session, NSError *error))block;</code><br><code>- (void)setSessionDidReceiveAuthenticationChallengeBlock:(nullable NSURLSessionAuthChallengeDisposition (^)(NSURLSession *session, NSURLAuthenticationChallenge *challenge, NSURLCredential * _Nullable __autoreleasing * _Nullable credential))block;</code></li>
<li>设置Task的代理回调<br><code>- (void)setTaskNeedNewBodyStreamBlock:(nullable NSInputStream * (^)(NSURLSession *session, NSURLSessionTask *task))block;</code><br><code>- (void)setTaskWillPerformHTTPRedirectionBlock:(nullable NSURLRequest * (^)(NSURLSession *session, NSURLSessionTask *task, NSURLResponse *response, NSURLRequest *request))block;</code><br><code>- (void)setTaskDidReceiveAuthenticationChallengeBlock:(nullable NSURLSessionAuthChallengeDisposition (^)(NSURLSession *session, NSURLSessionTask *task, NSURLAuthenticationChallenge *challenge, NSURLCredential * _Nullable __autoreleasing * _Nullable credential))block;</code><br><code>- (void)setTaskDidSendBodyDataBlock:(nullable void (^)(NSURLSession *session, NSURLSessionTask *task, int64_t bytesSent, int64_t totalBytesSent, int64_t totalBytesExpectedToSend))block;</code><br><code>- (void)setTaskDidCompleteBlock:(nullable void (^)(NSURLSession *session, NSURLSessionTask *task, NSError * _Nullable error))block;</code></li>
<li>设置Data Task 的代理回调<br><code>- (void)setDataTaskDidReceiveResponseBlock:(nullable NSURLSessionResponseDisposition (^)(NSURLSession *session, NSURLSessionDataTask *dataTask, NSURLResponse *response))block;</code><br><code>- (void)setDataTaskDidBecomeDownloadTaskBlock:(nullable void (^)(NSURLSession *session, NSURLSessionDataTask *dataTask, NSURLSessionDownloadTask *downloadTask))block;</code><br><code>- (void)setDataTaskDidReceiveDataBlock:(nullable void (^)(NSURLSession *session, NSURLSessionDataTask *dataTask, NSData *data))block;</code><br><code>- (void)setDataTaskWillCacheResponseBlock:(nullable NSCachedURLResponse * (^)(NSURLSession *session, NSURLSessionDataTask *dataTask, NSCachedURLResponse *proposedResponse))block;</code><br><code>- (void)setDidFinishEventsForBackgroundURLSessionBlock:(nullable void (^)(NSURLSession *session))block;</code></li>
<li>设置Download Task的回调方法<br><code>- (void)setDownloadTaskDidFinishDownloadingBlock:(nullable NSURL * _Nullable  (^)(NSURLSession *session, NSURLSessionDownloadTask *downloadTask, NSURL *location))block;</code><br><code>- (void)setDownloadTaskDidWriteDataBlock:(nullable void (^)(NSURLSession *session, NSURLSessionDownloadTask *downloadTask, int64_t bytesWritten, int64_t totalBytesWritten, int64_t totalBytesExpectedToWrite))block;</code><br><code>- (void)setDownloadTaskDidResumeBlock:(nullable void (^)(NSURLSession *session, NSURLSessionDownloadTask *downloadTask, int64_t fileOffset, int64_t expectedTotalBytes))block;</code></li>
<li>设置通知Notification</li>
</ol>
<h3 id="在-m-文件中"><a href="#在-m-文件中" class="headerlink" title="在.m 文件中"></a>在.m 文件中</h3><p>主要有是三个@interface和@implement。<br>一个是AFURLSessionManagerTaskDelegate。<br>一个是_AFURLSessionTaskSwizzling。<br>一个是AFURLSessionManager。</p>
<ol>
<li>AFURLSessionManagerTaskDelegate<br>遵守协议<nsurlsessiontaskdelegate, nsurlsessiondatadelegate,nsurlsessiondownloaddelegate="">，</nsurlsessiontaskdelegate,></li>
</ol>
<h4 id="NSProgress-Tracking"><a href="#NSProgress-Tracking" class="headerlink" title="NSProgress Tracking"></a>NSProgress Tracking</h4><p><code>- (void)setupProgressForTask:(NSURLSessionTask *)task</code><br>一部分是对代理持有的两个属性 uploadProgress和 downloadProgress设置回调<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self.uploadProgress.totalUnitCount </span>= task.countOfBytesExpectedToSend<span class="comment">;</span></span><br><span class="line">   [<span class="keyword">self.uploadProgress </span>setCancellable:YES]<span class="comment">;</span></span><br><span class="line">   [<span class="keyword">self.uploadProgress </span>setCancellationHandler:^&#123;</span><br><span class="line">       __typeof__(weakTask) <span class="keyword">strongTask </span>= weakTask<span class="comment">;</span></span><br><span class="line">       [<span class="keyword">strongTask </span>cancel]<span class="comment">;</span></span><br><span class="line">   &#125;]<span class="comment">;</span></span><br><span class="line">   [<span class="keyword">self.uploadProgress </span>setPausable:YES]<span class="comment">;</span></span><br><span class="line">   [<span class="keyword">self.uploadProgress </span>setPausingHandler:^&#123;</span><br><span class="line">       __typeof__(weakTask) <span class="keyword">strongTask </span>= weakTask<span class="comment">;</span></span><br><span class="line">       [<span class="keyword">strongTask </span>suspend]<span class="comment">;</span></span><br><span class="line">   &#125;]<span class="comment">;</span></span><br><span class="line">   <span class="preprocessor">if</span> ([<span class="keyword">self.uploadProgress </span>respondsToSelector:<span class="comment">@selector(setResumingHandler:)]) &#123;</span></span><br><span class="line">       [<span class="keyword">self.uploadProgress </span>setResumingHandler:^&#123;</span><br><span class="line">           __typeof__(weakTask) <span class="keyword">strongTask </span>= weakTask<span class="comment">;</span></span><br><span class="line">           [<span class="keyword">strongTask </span>resume]<span class="comment">;</span></span><br><span class="line">       &#125;]<span class="comment">;</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>设置上传的取消暂停，下载一样的道理。<br>另一个部分是对 task 和 NSProgress的uploadProgress和downloadPreogress属性进行键值观测。<br><code>- (void)cleanUpProgressForTask:(NSURLSessionTask *)task</code><br>主要是移除download和upload的observer。<br><code>- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSString *,id&gt; *)change context:(void *)context</code><br>主要是上面第一个函数中的实现NSURLSessionTask和NSURLSessionDownloadTask的类中下载和上传的的接收和期望接收的字节数，发送和期望发送的字节数。改变进度，并调用 block</p>
<h4 id="NSURLSessionTaskDelegate-1"><a href="#NSURLSessionTaskDelegate-1" class="headerlink" title="NSURLSessionTaskDelegate"></a>NSURLSessionTaskDelegate</h4><p><code>- (void)URLSession:(__unused NSURLSession *)session   task:(NSURLSessionTask *)task   didCompleteWithError:(NSError *)error</code><br>如果遇到error，dispatch_group_async，如果当前 manager持有 completionGroup或者 completionQueue就在主线程中调用 completionHandler并发送通知(在主线程中)<br>如果在执行当前 task 时没有遇到错误，那么先<strong>对数据进行序列化</strong>，然后同样调用 block 并发送通知。</p>
<h4 id="NSURLSessionDataTaskDelegate与NSURLSessionDownloadTaskDelegate"><a href="#NSURLSessionDataTaskDelegate与NSURLSessionDownloadTaskDelegate" class="headerlink" title="NSURLSessionDataTaskDelegate与NSURLSessionDownloadTaskDelegate"></a>NSURLSessionDataTaskDelegate与NSURLSessionDownloadTaskDelegate</h4><p><code>- (void)URLSession:(__unused NSURLSession *)session    dataTask:(__unused NSURLSessionDataTask *)dataTask    didReceiveData:(NSData *)data</code><br>在收到数据后调用。并拼接data.<br><code>- (void)URLSession:(NSURLSession *)session   downloadTask:(NSURLSessionDownloadTask *)downloadTask    didFinishDownloadingToURL:(NSURL *)location</code><br>在下载完成对应文件后调用，并处理下载文件。如果fileManagerError，则发出通知。</p>
<ol>
<li><p>_AFURLSessionTaskSwizzling<br>主要用到runtime的知识，来交换方法。修改 NSURLSessionTask的 resume和 suspend 方法。这样做的目的是为了在方法 resume或者 suspend被调用时发出通知。具体方法调剂过程是在 + load方法中进行的.a.首先用 NSClassFromString(@”NSURLSessionTask”)<br>判断当前部署的 iOS 版本是否含有类 NSURLSessionTask。b.因为 iOS7 和 iOS8 上对于 NSURLSessionTask的实现不同，所以会通过 - [NSURLSession dataTaskWithURL:]方法返回一个 NSURLSessionTask 实例。c .取得当前类 _AFURLSessionTaskSwizzling 中的实现 af_resume。d.如果当前类 currentClass有 resume。<br>方法真：使用 swizzleResumeAndSuspendMethodForClass:调剂该类的 resume 和 suspend方法<br>假：currentClass = [currentClass superclass]</p>
</li>
<li><p>AFURLSessionManager(最重要的地方)<br>a.初始化在<code>- (instancetype)initWithSessionConfiguration:(NSURLSessionConfiguration *)configuration</code>中，初始化会话配置，设置为默认的defaultSessionConfiguration，初始化会话session，并设置会话的代理和代理队列，初始化响应序列化responseSerializer，安全认证securityPolicy，和监控网络状态reachabilityManager。</p>
</li>
</ol>
<p>b. 两通知：<code>- (void)taskDidResume:(NSNotification *)notification</code>与<code>- (void)taskDidSuspend:(NSNotification *)notification</code></p>
<p>c.然后为NSURLSessionTask设置AFURLSessionManagerTaskDelegate，<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (AFURLSessionManagerTaskDelegate *)delegateForTask:(NSURLSessionTask *)task&#123;</span><br><span class="line">    NSParameterAssert(task);</span><br><span class="line">    AFURLSessionManagerTaskDelegate *<span class="keyword">delegate</span> = nil;</span><br><span class="line">    [self.<span class="keyword">lock</span> <span class="keyword">lock</span>];</span><br><span class="line">    <span class="keyword">delegate</span> = self.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)];</span><br><span class="line">    [self.<span class="keyword">lock</span> unlock];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">delegate</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AFURLSessionManager就是通过字典 mutableTaskDelegatesKeyedByTaskIdentifier来存储并管理每一个 NSURLSessionTask，它以 taskIdentifier为键存储 task。该方法使用 NSLock<br> 来保证不同线程使用 mutableTaskDelegatesKeyedByTaskIdentifier时，不会出现<strong>线程竞争</strong>的问题。</p>
<p>d.为DataTask加代理。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addDelegateForDataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">                uploadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">              downloadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">             completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br></pre></td></tr></table></figure></p>
<p>为uploadTask加代理,为downloadTask加代理。移除代理方法<br><code>- (void)removeDelegateForTask:(NSURLSessionTask *)task</code>.<br>用KVO检测<br><code>- (NSArray *)tasksForKeyPath:(NSString *)keyPath</code><br>如果无效session，则取消任务：<br><code>- (void)invalidateSessionCancelingTasks:(BOOL)cancelPendingTasks</code><br>设置response的序列<br><code>- (void)setResponseSerializer:(id &lt;AFURLResponseSerialization&gt;)responseSerializer</code><br>为任务添加(add)和移除(remove)通知观察者.<br><code>- (void)addNotificationObserverForTask:(NSURLSessionTask *)task</code></p>
<h4 id="管理NSURLSessionTask"><a href="#管理NSURLSessionTask" class="headerlink" title="管理NSURLSessionTask"></a>管理NSURLSessionTask</h4><p>先调用<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                            completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br></pre></td></tr></table></figure></p>
<p>方法传入NSURLRequest，<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               uploadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">                             downloadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">                            completionHandler:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> _Nullable responseObject,  <span class="built_in">NSError</span> * _Nullable error))completionHandler &#123;</span><br><span class="line"></span><br><span class="line">    __block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        dataTask = [<span class="keyword">self</span><span class="variable">.session</span> dataTaskWithRequest:request];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> addDelegateForDataTask:dataTask uploadProgress:uploadProgressBlock downloadProgress:downloadProgressBlock completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回一个 AFURLSessionManagerTaskDelegate对象，将 completionHandler的<br> uploadProgressBlock和 downloadProgressBlock 传入该对象并在相应事件发生时进行回调<br>然后</p>
<h1 id="Reachability"><a href="#Reachability" class="headerlink" title="Reachability"></a>Reachability</h1><h2 id="AFNetworkReachabilityManager"><a href="#AFNetworkReachabilityManager" class="headerlink" title="AFNetworkReachabilityManager"></a>AFNetworkReachabilityManager</h2><p>主要是网络的可用性，类似于苹果文档的<a href="https://developer.apple.com/library/ios/samplecode/reachability/" target="_blank" rel="external">Reachability</a><br> AFNetworkReachabilityStatusUnknow= -1,<br>AFNetworkReachabilityStatusNotReachable     = 0,<br>AFNetworkReachabilityStatusReachableViaWWAN = 1,<br>AFNetworkReachabilityStatusReachableViaWiFi = 2,</p>
<h3 id="在-h文件中-2"><a href="#在-h文件中-2" class="headerlink" title="在.h文件中"></a>在.h文件中</h3><p>先是初始化：<br><code>+ (instancetype)sharedManager;</code><br><code>+ (instancetype)manager;</code><br><code>+ (instancetype)managerForDomain:(NSString *)domain;</code><br><code>+ (instancetype)managerForAddress:(const void *)address;</code><br><code>- (instancetype)initWithReachability:(SCNetworkReachabilityRef)reachability NS_DESIGNATED_INITIALIZER;</code><br>然后开始或停止可用性的监控：<br><code>- (void)startMonitoring;</code><br><code>- (void)stopMonitoring;</code><br><code>- (NSString *)localizedNetworkReachabilityStatusString;</code><br>再设置网络可用性来改变回调：<br><code>- (void)setReachabilityStatusChangeBlock:(nullable void (^)(AFNetworkReachabilityStatus status))block;</code><br>最后是一些常量，通知和功能。</p>
<h3 id="在-m文件中："><a href="#在-m文件中：" class="headerlink" title="在.m文件中："></a>在.m文件中：</h3><p>初始化：<br><code>+ (instancetype)sharedManager</code>中用dispatch_once，调用<code>+ (instancetype)manager</code>,<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)managerForDomain:(<span class="built_in">NSString</span> *)domain &#123;</span><br><span class="line">    SCNetworkReachabilityRef reachability = SCNetworkReachabilityCreateWithName(k<span class="built_in">CFAllocatorDefault</span>, [domain UTF8String]);</span><br><span class="line">    AFNetworkReachabilityManager *manager = [[<span class="keyword">self</span> alloc] initWithReachability:reachability];</span><br><span class="line">    <span class="built_in">CFRelease</span>(reachability);</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br><span class="line">+ (instancetype)managerForAddress:(<span class="keyword">const</span> <span class="keyword">void</span> *)address &#123;</span><br><span class="line">    SCNetworkReachabilityRef reachability = SCNetworkReachabilityCreateWithAddress(k<span class="built_in">CFAllocatorDefault</span>, (<span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *)address);</span><br><span class="line">    AFNetworkReachabilityManager *manager = [[<span class="keyword">self</span> alloc] initWithReachability:reachability];</span><br><span class="line">    <span class="built_in">CFRelease</span>(reachability);   </span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>使用 SCNetworkReachabilityCreateWithAddress或者 SCNetworkReachabilityCreateWithName生成一个 SCNetworkReachabilityRef的引用。</li>
<li>两个方法会通过一个<strong>域名</strong>或者一个 sockaddr_in的指针生个 SCNetworkReachabilityRef。</li>
<li>调用 <code>- [AFNetworkReachabilityManager initWithReachability:]</code>将生成的 SCNetworkReachabilityRef引用传给networkReachability.</li>
<li>当调用 CFBridgingRelease(reachability)后，会把 reachability桥接成一个 NSObject 对象赋值给self.networkReachability，然后释放原来的 CoreFoundation 对象。</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithReachability:(SCNetworkReachabilityRef)reachability &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _networkReachability = <span class="built_in">CFRetain</span>(reachability);</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.networkReachabilityStatus</span> = AFNetworkReachabilityStatusUnknown;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>监控网络状态：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startMonitoring &#123;</span><br><span class="line">    [<span class="keyword">self</span> stopMonitoring];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span><span class="variable">.networkReachability</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    __<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    AFNetworkReachabilityStatusBlock callback = ^(AFNetworkReachabilityStatus status) &#123;</span><br><span class="line">        __<span class="keyword">strong</span> __<span class="keyword">typeof</span>(weakSelf)strongSelf = weakSelf;</span><br><span class="line">        strongSelf<span class="variable">.networkReachabilityStatus</span> = status;</span><br><span class="line">        <span class="keyword">if</span> (strongSelf<span class="variable">.networkReachabilityStatusBlock</span>) &#123;</span><br><span class="line">            strongSelf<span class="variable">.networkReachabilityStatusBlock</span>(status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    SCNetworkReachabilityContext context = &#123;<span class="number">0</span>, (__bridge <span class="keyword">void</span> *)callback, AFNetworkReachabilityRetainCallback, AFNetworkReachabilityReleaseCallback, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    SCNetworkReachabilitySetCallback(<span class="keyword">self</span><span class="variable">.networkReachability</span>, AFNetworkReachabilityCallback, &amp;context);</span><br><span class="line">    SCNetworkReachabilityScheduleWithRunLoop(<span class="keyword">self</span><span class="variable">.networkReachability</span>, <span class="built_in">CFRunLoopGetMain</span>(), k<span class="built_in">CFRunLoopCommonModes</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, <span class="number">0</span>),^&#123;</span><br><span class="line">        SCNetworkReachabilityFlags flags;</span><br><span class="line">        <span class="keyword">if</span> (SCNetworkReachabilityGetFlags(<span class="keyword">self</span><span class="variable">.networkReachability</span>, &amp;flags)) &#123;</span><br><span class="line">            AFPostReachabilityStatusChange(flags, callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)stopMonitoring &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span><span class="variable">.networkReachability</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SCNetworkReachabilityUnscheduleFromRunLoop(<span class="keyword">self</span><span class="variable">.networkReachability</span>, <span class="built_in">CFRunLoopGetMain</span>(), k<span class="built_in">CFRunLoopCommonModes</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>先调用 - stopMonitoring方法，如果之前设置过对网络状态的监听，使用SCNetworkReachabilityUnscheduleFromRunLoop方法取消之前在 Main Runloop 中的监听.</li>
<li>创建一个在每次网络状态改变时的回调block，每次回调被调用时，重新设置networkReachabilityStatus的属性，调用networkReachabilityStatus，</li>
<li>创建一个SCNetworkReachabilityContext，其中的 callback就是上一步中的创建的 block 对象。这里的 AFNetworkReachabilityRetainCallback 和 AFNetworkReachabilityReleaseCallback<br>都是非常简单的 block，在回调被调用时，只是使用 Block_copy和 Block_release<br>这样的宏。传入的 info<br>会以参数的形式在 AFNetworkReachabilityCallback<br>执行时传入<br>static const void <em> AFNetworkReachabilityRetainCallback(const void </em>info) { return Block_copy(info); }<br>static void AFNetworkReachabilityReleaseCallback(const void *info) { if (info) { Block_release(info); } }</li>
<li>当目标的网络状态改变时，会调用传入的回调</li>
<li>在 Main Runloop 中对应的模式开始监控网络状态。</li>
<li>取当前的网络状态，调用 callback<br>其中<code>SCNetworkReachabilitySetCallback(self.networkReachability, AFNetworkReachabilityCallback, &amp;context);</code>回调了AFNetworkReachabilityManager的AFNetworkReachabilityCallback。<br>总结：<br>AFNetworkReachabilityManager实际上只是一个对底层 SystemConfiguration库中的 C 函数封装的类，它为我们隐藏了 C 语言的实现，提供了统一的 Objective-C 语言接口。<br>它是 AFNetworking中一个即插即用的模块</li>
</ol>
<h1 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h1><h2 id="AFSecurityPolicy"><a href="#AFSecurityPolicy" class="headerlink" title="AFSecurityPolicy"></a>AFSecurityPolicy</h2><p>为了阻止中间人攻击，以及其它漏洞的工具。</p>
<p>用枚举设置了验证服务器被信任的方式SSL的类型有None，PublicKey，还有Certificate。<br>AFSSLPinningModeNone是默认的认证方式，只会在系统的信任的证书列表中对服务端返回的证书进行验证<br>AFSSLPinningModeCertificate需要客户端预先保存服务端的证书<br>AFSSLPinningModePublicKey也需要预先保存服务端发送的证书，但是这里只会验证证书中的公钥是否正确<br>遵守<nssecurecoding, nscopying="">。</nssecurecoding,></p>
<h3 id="从bundle获取证书-并返回"><a href="#从bundle获取证书-并返回" class="headerlink" title="从bundle获取证书,并返回"></a>从bundle获取证书,并返回</h3><p><code>+ (NSSet &lt;NSData *&gt; *)certificatesInBundle:(NSBundle *)bundle;</code></p>
<h3 id="获取特殊的安全策略"><a href="#获取特殊的安全策略" class="headerlink" title="获取特殊的安全策略"></a>获取特殊的安全策略</h3><p><code>+ (instancetype)defaultPolicy;</code></p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p><code>+ (instancetype)policyWithPinningMode:(AFSSLPinningMode)pinningMode;</code><br><code>+ (instancetype)policyWithPinningMode:(AFSSLPinningMode)pinningMode withPinnedCertificates:(NSSet &lt;NSData *&gt; *)pinnedCertificates;</code><br>初始化方法时，主要目的是设置<strong>验证服务器是否受信任的方式</strong>。</p>
<h3 id="验证服务端是否信任"><a href="#验证服务端是否信任" class="headerlink" title="验证服务端是否信任"></a>验证服务端是否信任</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)evaluateServerTrust:(SecTrustRef)serverTrust</span><br><span class="line">                  forDomain:(<span class="built_in">NSString</span> *)domain</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (domain &amp;&amp; <span class="keyword">self</span><span class="variable">.allowInvalidCertificates</span> &amp;&amp; <span class="keyword">self</span><span class="variable">.validatesDomainName</span> &amp;&amp; (<span class="keyword">self</span><span class="variable">.SSLPinningMode</span> == AFSSLPinningModeNone || [<span class="keyword">self</span><span class="variable">.pinnedCertificates</span> count] == <span class="number">0</span>)) &#123; </span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"In order to validate a domain name for self signed certificates, you MUST use pinning."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="built_in">NSMutableArray</span> *policies = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.validatesDomainName</span>) &#123;</span><br><span class="line">        [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateSSL(<span class="literal">true</span>, (__bridge <span class="built_in">CFStringRef</span>)domain)];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateBasicX509()];</span><br><span class="line">    &#125;</span><br><span class="line">    SecTrustSetPolicies(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)policies);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.SSLPinningMode</span> == AFSSLPinningModeNone) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span><span class="variable">.allowInvalidCertificates</span> || AFServerTrustIsValid(serverTrust);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!AFServerTrustIsValid(serverTrust) &amp;&amp; !<span class="keyword">self</span><span class="variable">.allowInvalidCertificates</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="keyword">self</span><span class="variable">.SSLPinningMode</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModeNone:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModeCertificate: &#123;</span><br><span class="line">            <span class="built_in">NSMutableArray</span> *pinnedCertificates = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSData</span> *certificateData <span class="keyword">in</span> <span class="keyword">self</span><span class="variable">.pinnedCertificates</span>) &#123;</span><br><span class="line">                [pinnedCertificates addObject:(__bridge_transfer <span class="keyword">id</span>)SecCertificateCreateWithData(<span class="literal">NULL</span>, (__bridge <span class="built_in">CFDataRef</span>)certificateData)];</span><br><span class="line">            &#125;</span><br><span class="line">            SecTrustSetAnchorCertificates(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)pinnedCertificates);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!AFServerTrustIsValid(serverTrust)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// obtain the chain after being validated, which *should* contain the pinned certificate in the last position (if it's the Root CA)</span></span><br><span class="line">            <span class="built_in">NSArray</span> *serverCertificates = AFCertificateTrustChainForServerTrust(serverTrust);            </span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSData</span> *trustChainCertificate <span class="keyword">in</span> [serverCertificates reverseObjectEnumerator]) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([<span class="keyword">self</span><span class="variable">.pinnedCertificates</span> containsObject:trustChainCertificate]) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;         </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModePublicKey: &#123;</span><br><span class="line">            <span class="built_in">NSUInteger</span> trustedPublicKeyCount = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">NSArray</span> *publicKeys = AFPublicKeyTrustChainForServerTrust(serverTrust);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">id</span> trustChainPublicKey <span class="keyword">in</span> publicKeys) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">id</span> pinnedPublicKey <span class="keyword">in</span> <span class="keyword">self</span><span class="variable">.pinnedPublicKeys</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (AFSecKeyIsEqualToKey((__bridge SecKeyRef)trustChainPublicKey, (__bridge SecKeyRef)pinnedPublicKey)) &#123;</span><br><span class="line">                        trustedPublicKeyCount += <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> trustedPublicKeyCount &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>所以如果没有提供证书或者不验证证书，并且还设置 allowInvalidCertificates为<strong>真</strong>，满足上面的所有条件，说明这次的验证是不安全的，会直接返回 NO.</li>
<li>设置 policy:如果要验证域名的话，就以域名为参数创建一个 SecPolicyRef，否则会创建一个符合 X509 标准的默认SecPolicyRef对象</li>
<li>验证证书的有效性:如果<strong>只根据信任列表中的证书</strong>进行验证，即 self.SSLPinningMode == AFSSLPinningModeNone<br>。如果允许无效的证书的就会直接返回 YES<br>。不允许就会对服务端信任进行验证。<br>如果服务器信任无效，并且不允许无效证书，就会返回 NO.</li>
<li>根据 SSLPinningMode对服务器信任进行验证<br>AFSSLPinningModeNone直接返回 NO<br>AFSSLPinningModeCertificate<br>AFSSLPinningModePublicKey</li>
</ol>
<h1 id="Serialization"><a href="#Serialization" class="headerlink" title="Serialization"></a>Serialization</h1><p>们<strong>对发出请求以及接收响应的过程</strong>进行序列化，这涉及到两个<strong>模块</strong>：</p>
<h2 id="AFURLRequestSerialization"><a href="#AFURLRequestSerialization" class="headerlink" title="AFURLRequestSerialization"></a>AFURLRequestSerialization</h2><p>修改请求（主要是 HTTP 请求）的头部，提供了一些语义明确的接口设置 HTTP 头部字段。<br>主要用于 AFHTTPSessionManager中，因为它主要用于<strong>修改 HTTP 头部</strong>。</p>
<h2 id="AFURLResponseSerialization（重要）"><a href="#AFURLResponseSerialization（重要）" class="headerlink" title="AFURLResponseSerialization（重要）"></a>AFURLResponseSerialization（重要）</h2><p>处理响应的模块，将请求返回的数据解析成对应的格式.这个模块使用在 AFURLSessionManager<br> 也就是核心类。其实也只是个协议<br><code>@protocol AFURLResponseSerialization &lt;NSObject, NSSecureCoding, NSCopying&gt;</code><br>遵循这个协议的类同时也要遵循 NSObject、NSSecureCoding 和 NSCopying 这三个协议，实现安全编码、拷贝以及 Objective-C 对象的基本行为。<br>这个协议只有一个必须实现的方法：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (nullable id)responseObjectForResponse:(nullable <span class="type">NSURLResponse</span> *)response</span><br><span class="line">                           <span class="typedef"><span class="keyword">data</span>:<span class="container">(<span class="title">nullable</span> <span class="type">NSData</span> *)</span><span class="keyword">data</span></span></span><br><span class="line">                          error:(<span class="type">NSError</span> * _Nullable __autoreleasing *)error <span class="type">NS_SWIFT_NOTHROW</span>;</span><br></pre></td></tr></table></figure></p>
<p>在.h文件中中有7个类：<br> 第一个<br><code>@interface AFHTTPResponseSerializer : NSObject &lt;AFURLResponseSerialization&gt;</code>剩下的六个AFJSONResponseSerializer，AFXMLParserResponseSerializer，AFXMLDocumentResponseSerializer，AFPropertyListResponseSerializer，AFImageResponseSerializer，AFCompoundResponseSerializer都继承自AFHTTPResponseSerializer。</p>
<h3 id="AFHTTPResponseSerializer"><a href="#AFHTTPResponseSerializer" class="headerlink" title="AFHTTPResponseSerializer"></a>AFHTTPResponseSerializer</h3><p>先看一下AFHTTPResponseSerializer的实现：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)serializer &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.stringEncoding</span> = <span class="built_in">NSUTF8StringEncoding</span>;</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.acceptableStatusCodes</span> = [<span class="built_in">NSIndexSet</span> indexSetWithIndexesInRange:<span class="built_in">NSMakeRange</span>(<span class="number">200</span>, <span class="number">100</span>)];</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.acceptableContentTypes</span> = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为是对 HTTP 响应进行序列化，所以这里设置了 stringEncoding为 NSUTF8StringEncoding而且没有对接收的内容类型加以限制。<br>将 acceptableStatusCodes设置为从 200 到 299 之间的状态码, 因为只有这些状态码表示<strong>获得了有效的响应</strong><br>验证响应的有效性：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)validateResponse:(<span class="built_in">NSHTTPURLResponse</span> *)response</span><br><span class="line">                    data:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                   error:(<span class="built_in">NSError</span> * __autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">BOOL</span> responseIsValid = <span class="literal">YES</span>;</span><br><span class="line">    <span class="built_in">NSError</span> *validationError = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (response &amp;&amp; [response isKindOfClass:[<span class="built_in">NSHTTPURLResponse</span> class]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.acceptableContentTypes</span> &amp;&amp; ![<span class="keyword">self</span><span class="variable">.acceptableContentTypes</span> containsObject:[response MIMEType]] &amp;&amp;</span><br><span class="line">            !([response MIMEType] == <span class="literal">nil</span> &amp;&amp; [data length] == <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([data length] &gt; <span class="number">0</span> &amp;&amp; [response URL]) &#123;</span><br><span class="line">                <span class="built_in">NSMutableDictionary</span> *mutableUserInfo = [@&#123;</span><br><span class="line">                                                          <span class="built_in">NSLocalizedDescriptionKey</span>: [<span class="built_in">NSString</span> stringWithFormat:<span class="built_in">NSLocalizedStringFromTable</span>(<span class="string">@"Request failed: unacceptable content-type: %@"</span>, <span class="string">@"AFNetworking"</span>, <span class="literal">nil</span>), [response MIMEType]],</span><br><span class="line">                                                          <span class="built_in">NSURLErrorFailingURLErrorKey</span>:[response URL],                                                          AFNetworkingOperationFailingURLResponseErrorKey: response,</span><br><span class="line">                                                        &#125; mutableCopy];</span><br><span class="line">                <span class="keyword">if</span> (data) &#123;</span><br><span class="line">                   mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;</span><br><span class="line">                &#125;</span><br><span class="line">                validationError = AFErrorWithUnderlyingError([<span class="built_in">NSError</span> errorWithDomain:AFURLResponseSerializationErrorDomain code:<span class="built_in">NSURLErrorCannotDecodeContentData</span> userInfo:mutableUserInfo], validationError);</span><br><span class="line">            &#125;</span><br><span class="line">            responseIsValid = <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.acceptableStatusCodes</span> &amp;&amp; ![<span class="keyword">self</span><span class="variable">.acceptableStatusCodes</span> containsIndex:(<span class="built_in">NSUInteger</span>)response<span class="variable">.statusCode</span>] &amp;&amp; [response URL]) &#123;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *mutableUserInfo = [@&#123;</span><br><span class="line">                                               <span class="built_in">NSLocalizedDescriptionKey</span>: [<span class="built_in">NSString</span> stringWithFormat:<span class="built_in">NSLocalizedStringFromTable</span>(<span class="string">@"Request failed: %@ (%ld)"</span>, <span class="string">@"AFNetworking"</span>, <span class="literal">nil</span>), [<span class="built_in">NSHTTPURLResponse</span> localizedStringForStatusCode:response<span class="variable">.statusCode</span>], (<span class="keyword">long</span>)response<span class="variable">.statusCode</span>],</span><br><span class="line">                                               <span class="built_in">NSURLErrorFailingURLErrorKey</span>:[response URL],</span><br><span class="line">                                               AFNetworkingOperationFailingURLResponseErrorKey: response,</span><br><span class="line">                                       &#125; mutableCopy];</span><br><span class="line">            <span class="keyword">if</span> (data) &#123;</span><br><span class="line">                mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;</span><br><span class="line">            &#125;</span><br><span class="line">            validationError = AFErrorWithUnderlyingError([<span class="built_in">NSError</span> errorWithDomain:AFURLResponseSerializationErrorDomain code:<span class="built_in">NSURLErrorBadServerResponse</span> userInfo:mutableUserInfo], validationError);</span><br><span class="line">            responseIsValid = <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (error &amp;&amp; !responseIsValid) &#123;</span><br><span class="line">        *error = validationError;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> responseIsValid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法根据在初始化方法中初始化的属性 acceptableContentTypes 和 acceptableStatusCodes来判断当前响应是否有效。</p>
<h3 id="AFURLResponseSerialization协议的实现"><a href="#AFURLResponseSerialization协议的实现" class="headerlink" title="AFURLResponseSerialization协议的实现"></a>AFURLResponseSerialization协议的实现</h3><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (id)responseObjectForResponse:(<span class="type">NSURLResponse</span> *)response</span><br><span class="line">                           <span class="typedef"><span class="keyword">data</span>:<span class="container">(<span class="type">NSData</span> *)</span><span class="keyword">data</span></span></span><br><span class="line">                          error:(<span class="type">NSError</span> *__autoreleasing *)error&#123;</span><br><span class="line">[self validateResponse:(<span class="type">NSHTTPURLResponse</span> *)response <span class="typedef"><span class="keyword">data</span>:<span class="keyword">data</span> error:error];</span></span><br><span class="line">    return <span class="typedef"><span class="keyword">data</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要是调用上面的方法对响应进行验证，然后返回数据，实在是没什么难度。</p>
<ol>
<li>NSSecureCoding<br>对安全协议的实现，就是支持安全编码，根据属性acceptableStatusCodes，acceptableContentTypes然后初始化，然后encode</li>
<li>NSCopying<br>实现copy属性<h3 id="AFJSONResponseSerializer"><a href="#AFJSONResponseSerializer" class="headerlink" title="AFJSONResponseSerializer"></a>AFJSONResponseSerializer</h3>初始化方法只是在调用父类的初始化方法之后更新了 acceptableContentTypes<br>属性：</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)<span class="keyword">init</span> &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> <span class="keyword">init</span>];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.acceptableContentTypes = [<span class="type">NSSet</span> setWithObjects:@<span class="string">"application/json"</span>, @<span class="string">"text/json"</span>, @<span class="string">"text/javascript"</span>, <span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个类中与父类差别最大的就是对 AFURLResponseSerialization协议的实现。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)responseObjectForResponse:(<span class="built_in">NSURLResponse</span> *)response data:(<span class="built_in">NSData</span> *)data error:(</span><br><span class="line"><span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123; </span><br><span class="line"><span class="preprocessor">#1: 验证请求</span></span><br><span class="line"> <span class="keyword">if</span> (![<span class="keyword">self</span> validateResponse:(<span class="built_in">NSHTTPURLResponse</span> *)response data:data error:error]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, <span class="built_in">NSURLErrorCannotDecodeContentData</span>, AFURLResponseSerializationErrorDomain)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="preprocessor">#2: 解决一个由只包含一个空格的响应引起的 bug, 略</span></span><br><span class="line"> <span class="preprocessor">#3: 序列化 JSON</span></span><br><span class="line">  <span class="keyword">id</span> responseObject = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// Workaround for behavior of Rails to return a single space for `head :ok` (a workaround for a bug in Safari), which is not interpreted as valid input by NSJSONSerialization.</span></span><br><span class="line">    <span class="comment">// See https://github.com/rails/rails/issues/1742</span></span><br><span class="line">    <span class="built_in">BOOL</span> isSpace = [data isEqualToData:[<span class="built_in">NSData</span> dataWithBytes:<span class="string">" "</span> length:<span class="number">1</span>]];</span><br><span class="line">    <span class="keyword">if</span> (data<span class="variable">.length</span> &gt; <span class="number">0</span> &amp;&amp; !isSpace) &#123;</span><br><span class="line">        responseObject = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:data options:<span class="keyword">self</span><span class="variable">.readingOptions</span> error:&amp;serializationError];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.removesKeysWithNullValues</span> &amp;&amp; responseObject) &#123;</span><br><span class="line">        responseObject = AFJSONObjectByRemovingKeysWithNullValues(responseObject, <span class="keyword">self</span><span class="variable">.readingOptions</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="preprocessor">#4: 移除 JSON 中的 null </span></span><br><span class="line"><span class="keyword">if</span> (error) &#123; </span><br><span class="line">*error = AFErrorWithUnderlyingError(serializationError, *error); &#125; </span><br><span class="line"><span class="keyword">return</span> responseObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后实现NSSecureCoding，NSCopying与上面类似<br>其他几个子类实现差不多。</p>
<h2 id="AFURLRequestSerialization-1"><a href="#AFURLRequestSerialization-1" class="headerlink" title="AFURLRequestSerialization"></a>AFURLRequestSerialization</h2><p>AFURLRequestSerialization的主要工作是对发出的 HTTP 请求进行处理，它有几部分的工作需要完成。<br>而这个文件中的大部分类都是为 AFHTTPRequestSerializer服务的：</p>
<ol>
<li>处理查询的 URL 参数</li>
<li>设置 HTTP 头部字段</li>
<li>设置请求的属性</li>
<li>分块上传</li>
</ol>
<h3 id="处理查询参数"><a href="#处理查询参数" class="headerlink" title="处理查询参数"></a>处理查询参数</h3><p>处理查询参数这部分主要是通过 AFQueryStringPair还有一些 C 函数来完成的，这个类有两个属性 field和 value对应 HTTP 请求的查询 URL 中的参数。在.m文件中，先是它的实现。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFQueryStringPair</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> field;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> value;</span><br><span class="line">- (instancetype)initWithField:(<span class="keyword">id</span>)field value:(<span class="keyword">id</span>)value;</span><br><span class="line">- (<span class="built_in">NSString</span> *)URLEncodedStringValue;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>其中URLEncodedStringValue方法会返回<br><code>return [NSString stringWithFormat:@&quot;%@=%@&quot;, AFPercentEscapedStringFromString([self.field description]), AFPercentEscapedStringFromString([self.value description])];</code><br>key=value这种格式，同时使用 AFPercentEscapedStringFromString函数来对 field和 value进行处理，将其中的 :#[]@!$&amp;’()*+,;=等字符转换为百分号表示的形式。<br>这一部分代码还负责返回查询参数，将 AFQueryStringPair中key和value<br> 转换为以下这种形式：<br>username=tom&amp;password=123456&amp;hello[world]=helloworld<br>下面是用FOUNDATION_EXPORT定义的NSArray的数组，有AFQueryStringPairsFromDictionary，AFQueryStringPairsFromKeyAndValue，AFQueryStringFromParameters，AFQueryStringPairsFromDictionary，AFQueryStringPairsFromKeyAndValue。<br>它的实现主要依赖于一个递归函数 AFQueryStringPairsFromKeyAndValue，如果当前的 value<br> 是一个集合类型的话，那么它就会不断地递归调用自己。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">NSArray * AFQueryStringPairsFromKeyAndValue(NSString *key, id value) &#123;</span><br><span class="line">    NSMutableArray *mutableQueryStringComponents = [NSMutableArray array];</span><br><span class="line">    NSSortDescriptor *sortDescriptor = [NSSortDescriptor <span class="string">sortDescriptorWithKey:</span>@<span class="string">"description"</span> <span class="string">ascending:</span>YES <span class="string">selector:</span><span class="annotation">@selector</span>(<span class="string">compare:</span>)];</span><br><span class="line">    <span class="keyword">if</span> ([value <span class="string">isKindOfClass:</span>[NSDictionary <span class="class"><span class="keyword">class</span>]]) &#123;</span></span><br><span class="line">        NSDictionary *dictionary = value;</span><br><span class="line">        <span class="comment">// Sort dictionary keys to ensure consistent ordering in query string, which is important when deserializing potentially ambiguous sequences, such as an array of dictionaries</span></span><br><span class="line">        <span class="keyword">for</span> (id nestedKey <span class="keyword">in</span> [dictionary.allKeys <span class="string">sortedArrayUsingDescriptors:</span>@[ sortDescriptor ]]) &#123;</span><br><span class="line">            id nestedValue = dictionary[nestedKey];</span><br><span class="line">            <span class="keyword">if</span> (nestedValue) &#123;</span><br><span class="line">                [mutableQueryStringComponents <span class="string">addObjectsFromArray:</span>AFQueryStringPairsFromKeyAndValue((key ? [NSString stringWithFormat:@<span class="string">"%@[%@]"</span>, key, nestedKey] : nestedKey), nestedValue)];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value <span class="string">isKindOfClass:</span>[NSArray <span class="class"><span class="keyword">class</span>]]) &#123;</span></span><br><span class="line">        NSArray *array = value;</span><br><span class="line">        <span class="keyword">for</span> (id nestedValue <span class="keyword">in</span> array) &#123;</span><br><span class="line">            [mutableQueryStringComponents <span class="string">addObjectsFromArray:</span>AFQueryStringPairsFromKeyAndValue([NSString <span class="string">stringWithFormat:</span>@<span class="string">"%@[]"</span>, key], nestedValue)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value <span class="string">isKindOfClass:</span>[NSSet <span class="class"><span class="keyword">class</span>]]) &#123;</span></span><br><span class="line">        NSSet *set = value;</span><br><span class="line">        <span class="keyword">for</span> (id obj <span class="keyword">in</span> [set <span class="string">sortedArrayUsingDescriptors:</span>@[ sortDescriptor ]]) &#123;</span><br><span class="line">            [mutableQueryStringComponents <span class="string">addObjectsFromArray:</span>AFQueryStringPairsFromKeyAndValue(key, obj)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [mutableQueryStringComponents <span class="string">addObject:</span>[[AFQueryStringPair alloc] <span class="string">initWithField:</span>key <span class="string">value:</span>value]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mutableQueryStringComponents;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回一个数组<br>[ username=tom, password=123456, hello[world]=helloworld]<br>得到这个数组之后就会调用 AFQueryStringFromParameters使用 &amp;来拼接它们。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> * AFQueryStringFromParameters(<span class="built_in">NSDictionary</span> *parameters) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutablePairs = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">for</span> (AFQueryStringPair *pair <span class="keyword">in</span> AFQueryStringPairsFromDictionary(parameters)) &#123;</span><br><span class="line">        [mutablePairs addObject:[pair URLEncodedStringValue]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [mutablePairs componentsJoinedByString:<span class="string">@"&amp;"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>设置请求的属性<br>这个下面有一个AFStreamingMultipartFormData的声明，是多形式的数据流。<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * AFHTTPRequestSerializerObservedKeyPaths() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSArray</span> *_AFHTTPRequestSerializerObservedKeyPaths = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        _AFHTTPRequestSerializerObservedKeyPaths = @[<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowsCellularAccess)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldHandleCookies)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldUsePipelining)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(networkServiceType)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(timeoutInterval))];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> _AFHTTPRequestSerializerObservedKeyPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>在这些属性被设置时，会触发 KVO，然后将新的属性存储在一个名为 mutableObservedChangedKeyPaths的字典中：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">-</span> (void)<span class="tag">observeValueForKeyPath</span>:(NSString *)<span class="tag">keyPath</span></span><br><span class="line">                      <span class="tag">ofObject</span>:(__unused id)<span class="tag">object</span></span><br><span class="line">                        <span class="tag">change</span>:(NSDictionary *)<span class="tag">change</span></span><br><span class="line">                       <span class="tag">context</span>:(void *)<span class="tag">context</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="tag">if</span> (context == AFHTTPRequestSerializerObserverContext) &#123;</span><br><span class="line">        <span class="tag">if</span> ([change[NSKeyValueChangeNewKey] <span class="attribute">isEqual</span>:[NSNull null]]) &#123;</span><br><span class="line">            <span class="attr_selector">[self.mutableObservedChangedKeyPaths removeObject:keyPath]</span>;</span><br><span class="line">        &#125; <span class="tag">else</span> &#123;</span><br><span class="line">            <span class="attr_selector">[self.mutableObservedChangedKeyPaths addObject:keyPath]</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后会在生成NSURLRequest的时候设置这些属性：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NSMutableURLRequest *mutableRequest = [[NSMutableURLRequest alloc] initWithURL:url];</span><br><span class="line">    mutableRequest.HTTPMethod = <span class="function"><span class="keyword">method</span>;</span></span><br><span class="line">    <span class="keyword">for</span> (NSString *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) <span class="comment">&#123;</span><br><span class="line">        if ([self.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</span><br><span class="line">            [mutableRequest setValue:[self valueForKeyPath:keyPath] forKey:keyPath];</span><br><span class="line">        &#125;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>设置HTTP头部字段<br>在AFHTTPRequestSerializer的interface文件中提供了一些属性方便我们设置 HTTP 头部字段<br>mutableHTTPRequestHeaders.</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSDictionary</span> *)HTTPRequestHeaders &#123;</span><br><span class="line"><span class="comment">//在设置 HTTP 头部字段时，都会存储到这个可变字典中。而当真正使用时，用这个方法，来获取对应版本的不可变字典。</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSDictionary</span> dictionaryWithDictionary:<span class="keyword">self</span><span class="variable">.mutableHTTPRequestHeaders</span>];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="built_in">NSString</span> *)value</span><br><span class="line">forHTTPHeaderField:(<span class="built_in">NSString</span> *)field</span><br><span class="line">&#123;</span><br><span class="line">	[<span class="keyword">self</span><span class="variable">.mutableHTTPRequestHeaders</span> setValue:value forKey:field];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">NSString</span> *)valueForHTTPHeaderField:(<span class="built_in">NSString</span> *)field &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span><span class="variable">.mutableHTTPRequestHeaders</span> valueForKey:field];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个类是如何设置一些我们平时常用的头部字段的。首先是 User-Agent，AFHTTPRequestSerializer刚刚初始化时，就会根据当前编译的平台生成一个 userAgent。在iOS，ios_watch还有iOS_VERSION_MIN的平台下生成不同。<br>之后有方法设置授权头部用用户名和密码，还有清除方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setAuthorizationHeaderFieldWithUsername:(<span class="built_in">NSString</span> *)username</span><br><span class="line">                                       password:(<span class="built_in">NSString</span> *)password</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSData</span> *basicAuthCredentials = [[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@:%@"</span>, username, password] dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *base64AuthCredentials = [basicAuthCredentials base64EncodedStringWithOptions:(<span class="built_in">NSDataBase64EncodingOptions</span>)<span class="number">0</span>];</span><br><span class="line">    [<span class="keyword">self</span> setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Basic %@"</span>, base64AuthCredentials] forHTTPHeaderField:<span class="string">@"Authorization"</span>];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)clearAuthorizationHeader &#123;</span><br><span class="line">	[<span class="keyword">self</span><span class="variable">.mutableHTTPRequestHeaders</span> removeObjectForKey:<span class="string">@"Authorization"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>设置了AFHTTPBodyPart，AFMultipartBodyStream的@interface。</p>
<p> 字符串：</p>
<p>#UIKit+AFNetworking</p>
<p>参考：<br><a href="https://github.com/Draveness/iOS-Source-Code-Analyze/blob/master/AFNetworking/%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94%20AFURLSerialization%EF%BC%88%E4%B8%89%EF%BC%89.md" target="_blank" rel="external">源码解析</a></p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2017/06/05/AFNetworking3.0/">AFNetworking3.0</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 向阳 的个人博客">向阳</a></p>
        <p><span>发布时间:</span>2017年06月05日 - 14时08分</p>
        <p><span>最后更新:</span>2018年07月18日 - 09时34分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/06/05/AFNetworking3.0/" title="AFNetworking3.0">http://peilinghui.com/2017/06/05/AFNetworking3.0/</a>
            <span class="copy-path" data-clipboard-text="原文: http://peilinghui.com/2017/06/05/AFNetworking3.0/　　作者: 向阳" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2017/06/14/Jenkins搭建来实现自动化打包/">
                    Jenkins搭建来实现自动化打包
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2017/05/27/搜索框的Demo/">
                    搜索框的Demo
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#AFNetworking3-0"><span class="toc-number">1.</span> <span class="toc-text">AFNetworking3.0</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NSURLSession"><span class="toc-number">2.</span> <span class="toc-text">NSURLSession</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AFNHTTPSessionManager"><span class="toc-number">2.1.</span> <span class="toc-text">AFNHTTPSessionManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在-h文件中"><span class="toc-number">2.1.1.</span> <span class="toc-text">在.h文件中</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定义属性"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">定义属性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在-m文件中"><span class="toc-number">2.1.2.</span> <span class="toc-text">在.m文件中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AFURLSessionManager"><span class="toc-number">2.2.</span> <span class="toc-text">AFURLSessionManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NSURLSession-amp-NSURLSessionTask-Delegate-Methods："><span class="toc-number">2.2.1.</span> <span class="toc-text">NSURLSession & NSURLSessionTask Delegate Methods：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NSURLSessionDelegate"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">NSURLSessionDelegate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSURLSessionTaskDelegate"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">NSURLSessionTaskDelegate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSURLSessionDataDelegate"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">NSURLSessionDataDelegate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSURLSessionDownloadDelegate"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">NSURLSessionDownloadDelegate</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在-h文件中-1"><span class="toc-number">2.2.2.</span> <span class="toc-text">在.h文件中</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定义属性-1"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">定义属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定义方法："><span class="toc-number">2.2.2.2.</span> <span class="toc-text">定义方法：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在-m-文件中"><span class="toc-number">2.2.3.</span> <span class="toc-text">在.m 文件中</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NSProgress-Tracking"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">NSProgress Tracking</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSURLSessionTaskDelegate-1"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">NSURLSessionTaskDelegate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NSURLSessionDataTaskDelegate与NSURLSessionDownloadTaskDelegate"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">NSURLSessionDataTaskDelegate与NSURLSessionDownloadTaskDelegate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#管理NSURLSessionTask"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">管理NSURLSessionTask</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reachability"><span class="toc-number">3.</span> <span class="toc-text">Reachability</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AFNetworkReachabilityManager"><span class="toc-number">3.1.</span> <span class="toc-text">AFNetworkReachabilityManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在-h文件中-2"><span class="toc-number">3.1.1.</span> <span class="toc-text">在.h文件中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在-m文件中："><span class="toc-number">3.1.2.</span> <span class="toc-text">在.m文件中：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Security"><span class="toc-number">4.</span> <span class="toc-text">Security</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AFSecurityPolicy"><span class="toc-number">4.1.</span> <span class="toc-text">AFSecurityPolicy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#从bundle获取证书-并返回"><span class="toc-number">4.1.1.</span> <span class="toc-text">从bundle获取证书,并返回</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取特殊的安全策略"><span class="toc-number">4.1.2.</span> <span class="toc-text">获取特殊的安全策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化"><span class="toc-number">4.1.3.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证服务端是否信任"><span class="toc-number">4.1.4.</span> <span class="toc-text">验证服务端是否信任</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Serialization"><span class="toc-number">5.</span> <span class="toc-text">Serialization</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AFURLRequestSerialization"><span class="toc-number">5.1.</span> <span class="toc-text">AFURLRequestSerialization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AFURLResponseSerialization（重要）"><span class="toc-number">5.2.</span> <span class="toc-text">AFURLResponseSerialization（重要）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AFHTTPResponseSerializer"><span class="toc-number">5.2.1.</span> <span class="toc-text">AFHTTPResponseSerializer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AFURLResponseSerialization协议的实现"><span class="toc-number">5.2.2.</span> <span class="toc-text">AFURLResponseSerialization协议的实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AFJSONResponseSerializer"><span class="toc-number">5.2.3.</span> <span class="toc-text">AFJSONResponseSerializer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AFURLRequestSerialization-1"><span class="toc-number">5.3.</span> <span class="toc-text">AFURLRequestSerialization</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#处理查询参数"><span class="toc-number">5.3.1.</span> <span class="toc-text">处理查询参数</span></a></li></ol></li></ol></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>




    <div class="share">
    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
    <a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
    <a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
    </div>
    <script>
        window._bd_share_config={
            "common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
    </script>
</div>



    
      <div class="duoshuo" id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2017/06/05/AFNetworking3.0/" data-title="AFNetworking3.0" data-url="http://peilinghui.com/2017/06/05/AFNetworking3.0/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"peilinghui"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    <!-- 多说公共JS代码 end -->
</div>

    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2017/06/14/Jenkins搭建来实现自动化打包/" title="上一篇: Jenkins搭建来实现自动化打包">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2017/05/27/搜索框的Demo/" title="下一篇: 搜索框的Demo">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/12/ReactNative中使用Redux/">ReactNative中使用Redux</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/24/React-Native的APP/">React-Native的APP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/27/ReactNative的常用组件/">ReactNative的常用组件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/14/iOS应用APP架构/">iOS应用APP架构</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/10/iOS网络层的封装/">iOS网络层的封装</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/05/项目重构遇到的问题/">项目重构遇到的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/30/iOS中的图表Charts/">iOS中的图表Charts</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/移动应用的设计模式/">移动应用的设计模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/Jenkins搭建来实现自动化打包/">Jenkins搭建来实现自动化打包</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/05/AFNetworking3.0/">AFNetworking3.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/27/搜索框的Demo/">搜索框的Demo</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/27/使用Mac本地服务器/">如何使用Mac本地服务器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/10/iOS打包和发布流程/">iOS打包和发布流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/05/iOS中JS与OC相互调用的方式/">iOS中JS与OC相互调用的方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/30/NSURLProtocol/">NSURLProtocol</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/21/UIView的Frame和bounds区别/">UIView的Frame和bounds区别</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/21/React-Native的与原生的交互/">React-Native的与原生的交互</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/10/React-Native的API和组件/">React-Native的API和组件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/02/React-Native入门/">React Native入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/React知识/">React知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/16/自动化测试/">自动化测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/13/JavaScript高级程序设计读书笔记/">JavaScript高级程序设计读书笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/03/YYModel/">YYModel</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/20/Quartz2D的使用/">Quartz2D的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/02/iOS中的加密实现/">iOS中的加密实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/12/iOS的开发设计模式/">iOS的开发设计模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/05/GCD/">GCD</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/20/KVC和KVO/">深入学习KVC和KVO</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/19/RunLoop/">RunLoop</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/10/消息处理之performSelector/">消息处理之performSelector</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/05/Runtime/">Runtime</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/02/TableView的一些事/">TableView的一些事</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/02/iOS中页面传值和页面跳转/">iOS中页面传值和页面跳转</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/01/ARC内存管理/">ARC内存管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/29/ReactiveCocoa学习笔记/">ReactiveCocoa学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/14/iOS调试技巧/">iOS调试技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/14/iOS网络编程/">iOS网络编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/10/NSString的引用计数问题/">NSString的引用计数问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/03/effective objective-c 2.0读书笔记/">effective objective-c 2.0读书笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/01/设计模式/">设计模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/01/Block/">Block</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/25/剑指offer/">剑指offer</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/21/Linux系统的学习/">Linux系统的学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/14/ViewController的生命周期/">ViewController的生命周期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/06/SDWebImage框架/">SDWebImage框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/05/AFNetworking2.0/">AFNetworking2.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/05/iOS中的第三方框架/">iOS中的第三方库</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/05/iOS中的数据存储/">iOS中的数据存储</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/04/iOS中的多线程网络/">iOS中的多线程网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/04/CocosPods/">CocosPods</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/03/深拷贝和浅拷贝/">深拷贝和浅拷贝</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/计算机基础知识/">计算机基础知识总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/计算机网络基础知识与安全/">计算机网络基础知识与安全</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/经典排序算法总结与实现/">经典排序算法总结与实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/25/git学习/">git学习笔记</a></li></ul>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2018 向阳
            </div>
            <div class="footer-right">
	     欢迎光临小站
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >本站到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.1.22/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>


<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>