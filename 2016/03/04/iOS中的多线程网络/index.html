<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>iOS中的多线程网络 | 向着阳光奔跑</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="不论是什么开发，多线程网络始终是学习的重点。">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS中的多线程网络">
<meta property="og:url" content="http://peilinghui.com/2016/03/04/iOS中的多线程网络/index.html">
<meta property="og:site_name" content="向着阳光奔跑">
<meta property="og:description" content="不论是什么开发，多线程网络始终是学习的重点。">
<meta property="og:image" content="http://7xr8q7.com1.z0.glb.clouddn.com/%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF.png">
<meta property="og:image" content="http://7xr8q7.com1.z0.glb.clouddn.com/%E8%87%AA%E5%AE%9A%E4%B9%89NSOperation%E4%B8%8B%E8%BD%BD%E5%9B%BE%E7%89%87.png">
<meta property="og:image" content="http://7xr8q7.com1.z0.glb.clouddn.com/runloop.png">
<meta property="og:updated_time" content="2016-07-16T01:03:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS中的多线程网络">
<meta name="twitter:description" content="不论是什么开发，多线程网络始终是学习的重点。">
  
    <link rel="alternative" href="/atom.xml" title="向着阳光奔跑" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" type="text/css">
  
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false,
      }
  </script>

  
      <script>
          yiliaConfig.rootUrl = "/";
      </script>
  

  
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/images/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">向阳</a></h1>
        </hgroup>

        
        <p class="header-subtitle">没有到不了的远方</p>
        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="/peilinghuibest@gmail.com" title="Email"></a></li>
                            
                                <li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/575544059" title="新浪微博"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/peilinghui" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/OC/" style="font-size: 10px;">OC</a> <a href="/tags/RAC-学习笔记/" style="font-size: 10px;">RAC,学习笔记</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/iOS面试/" style="font-size: 10px;">iOS面试</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/学习笔记/" style="font-size: 10px;">学习笔记</a> <a href="/tags/读书笔记/" style="font-size: 20px;">读书笔记</a> <a href="/tags/面试/" style="font-size: 20px;">面试</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://lysongzi.com/">小松子</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/CHENYUFENG1991/article/category/5655903/4">iOS大神</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://cspilgrimzww.github.io/">蔚蔚</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.changhuiyuan.com/">惠源</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.hxdavid.com/">PAT大神</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://wut0719.github.io/">桐神</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://pangjiuzala.github.io/">兴爷</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://han.pm/">交换生</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://frankhu.me">frank</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://judyzhangxin.com/">UI设计师</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://sunus.me/">阿里学长</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://imhuchao.com/">胡超-凤凰网</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.xuanzhangjiong.xyz/">囧囧囧-网易安卓</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">没有到不了的远方，向往远方。。</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">向阳</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/images/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">向阳</a></h1>
            </hgroup>
            
            <p class="header-subtitle">没有到不了的远方</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="/peilinghuibest@gmail.com" title="Email"></a></li>
                            
                                <li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/575544059" title="新浪微博"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/peilinghui" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-iOS中的多线程网络" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/04/iOS中的多线程网络/" class="article-date">
      <time datetime="2016-03-04T13:31:31.000Z" itemprop="datePublished">2016-03-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      iOS中的多线程网络
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>不论是什么开发，多线程网络始终是学习的重点。<br><a id="more"></a></p>
<h1 id="多线程网络"><a href="#多线程网络" class="headerlink" title="多线程网络"></a>多线程网络</h1><h2 id="NSthread"><a href="#NSthread" class="headerlink" title="NSthread"></a>NSthread</h2><ol>
<li>创建和启动线程</li>
</ol>
<p>//创建一个新线程对象，实例方法，返回一个NSThread对象必须调用start方法启动线程 （实例方法）<br><code>-(id)initWithTarget:(id)target selector:(SEL)selector object:(id)arg:</code><br>//创建并启动新线程，不会返回NSThread对象。会直接创建并启动线程(类方法)<br><code>+(void)detachNewThreadSelector:(SEL)selector toTarget:(id)target withObject:(id)arg:</code></p>
<p>target对象的selector方法的方法体代表了线程需要完成的任务，相当于把target对象的selector方法转换为线程执行体. </p>
<pre><code>//创建多线程对象
NSThread *thread = [[NSThread alloc]initWithTarget:self selector:@selector(run) object:nil];
//启动多线程
[thread start];

//创建并启动多线程
[NSThread detachNewThreadSelector:@selector(run) toTarget:self withObject:nil];
</code></pre><ol>
<li><p>线程的状态<br>线程的状态会在运行、就绪状态之间切换。<br>启用线程使用了start方法后，该线程进入就绪状态，系统会为其创建方法调用栈和程序计数器。<strong>当系统调度线程后，线程才会进入运行状态。</strong><br>注意：若想要子线程的start方法后子线程立即开始执行，可以调用[NSThread sleepForTimeInterval:0.01];<br>从而让子线程立即获得执行。</p>
</li>
<li><p>终止子线程<br>1&gt;线程执行体方法执行完成，线程正常结束。<br>2&gt;线程执行过程中出现了错误<br>3&gt;直接调用NSThread类的exit方法来中止当前正在执行的线程。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">if</span> ([NSThread currentThread].isCancelled) &#123;</span><br><span class="line">        <span class="comment">//中止当前正在执行的线程</span></span><br><span class="line">        <span class="attr_selector">[NSThread exit]</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>线程睡眠<br>NSThread的两种类方法：<br>//让当前正在执行的线程暂停到aDate代表的时间，并进入阻塞状态<br><code>+ (void)sleepUntilDate:(NSDate *)aDate:</code><br>//让当前正在执行的线程暂停ti秒，并进入阻塞状态<br><code>+ (void)sleepForTimeInterval:(NSTimeInterval)ti:</code></li>
</ol>
<p>例子：<br>使用线程下载网络图片：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建多线程对象</span></span><br><span class="line">NSThread *thread = [[NSThread alloc]<span class="string">initWithTarget:</span>self <span class="string">selector:</span><span class="annotation">@selector</span>(<span class="string">downloadImageFromURL:</span>) <span class="string">object:</span>nil];</span><br><span class="line"><span class="comment">//启动多线程</span></span><br><span class="line">[thread start];</span><br><span class="line"><span class="string">downloadImageFromURL:</span>方法作为线程执行体，当线程启动调用该方法。</span><br><span class="line"><span class="comment">//在主线程中执行updateUI：方法 来更新iv控件显示的图片</span></span><br><span class="line">[self <span class="string">performSelectorOnMainThread:</span><span class="annotation">@selector</span>(<span class="string">updateUI:</span>) <span class="string">withObject:</span>image <span class="string">waitUntilDone:</span>YES];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>iOS规定只能在UI线程中修改UI控件的属性</strong></p>
<ol>
<li>改变优先级<br>NSThread中的实例方法和类方法：<br>+threadPriority<br>-threadPriority<br>+setThreadPriority：(double)priority:<br>-setThreadPriority：(double)priority:</li>
</ol>
<h3 id="线程同步与线程通信"><a href="#线程同步与线程通信" class="headerlink" title="线程同步与线程通信"></a>线程同步与线程通信</h3><ol>
<li><p>在多线程中引入同步解决线程安全问题<br>使用方法： @synchronized (obj) {</p>
<pre><code>//同步代码块
</code></pre><p> }<br>obj是同步监视器<br>任何时刻只能有一个线程可以获得对同步监视器的锁定，当同步代码块执行完毕的后，该线程会释放对同步监视器的锁定。<br>可变类的线程安全是以降低程序的运行效率作为代价的，为了减少线程安全所带来的负面影响，程序可以采用：</p>
<ul>
<li>不要对线程安全类的所有方法都进行同步，只对那些会改变竞争资源的方法进行同步。</li>
<li>如果可变类有两种运行环境：单线程和多线程环境，则应该为该可变类提供两种版本-单线程环境中使用线程不安全版本以保证性能，多线程环境中使用线程安全版本。</li>
</ul>
</li>
<li><p>释放对同步监视器的锁定<br>任何线程在进入同步代码块之前，必须先获得对同步监视器的锁定，那么何时会释放对同步监视器的锁定呢？</p>
<ul>
<li>当前线程的同步代码块执行结束  </li>
<li>当前代码块在同步代码块中遇到了goto.return终止了该代码块、该方法继续执行时，当前线程会释放同步监视器。</li>
<li>当线程在同步代码块中出现了错误，导致该代码块异常结束时，将会释放同步监视器。</li>
</ul>
</li>
</ol>
<ol>
<li><p>同步锁（NSLock）<br>Foundation提供NSLock，通过显式定义同步锁对象来实现同步。<br>NSlock是控制多个线程对共享资源进行访问的工具，通常锁提供了对共享资源的独占访问。在实现线程安全的控制中，使用NSlock对象可以显示地加锁，释放锁。</p>
</li>
<li><p>使用NSCondition控制线程通信<br>NSCondition实现了NSLocking协议，因此也可以调用lock，unlock来实现线程同步。也可以让那些已经锁定NSCondition对象却无法继续执行的线程释放NSCondition对象，NSCondition对象也可以唤醒其他处于等待状态的线程。<br>方法：-wait，知道其他线程调用NSCondition的signal方法或broadcast方法来唤醒该线程。<br>-（BOOL）waitUntilDate：(NSDate *)limiteout,</p>
</li>
</ol>
<p>参考：<a href="http://blog.csdn.net/totogo2010/article/details/8010231" target="_blank" rel="external">http://blog.csdn.net/totogo2010/article/details/8010231</a></p>
<h1 id="GCD"><a href="#GCD" class="headerlink" title="GCD"></a>GCD</h1><ol>
<li>Grand Central Dispatch “牛逼的中枢调度器”</li>
</ol>
<ul>
<li>是苹果公司为多核的并行运算提出的解决方案</li>
<li>GCD会自动利用更多CPU内核</li>
<li>会自动管理线程的生命周期（创建线程，调度任务，销毁线程）</li>
<li>程序员只需要告诉GCD该做什么，而不需要写代码</li>
</ul>
<ol>
<li><p>使用2个步骤：</p>
<ul>
<li>定制任务（执行什么操作）</li>
<li>将任务添加到队列中（GCD会自动将队列中的任务取出，放到对应的线程中执行）（先进先出，后进后出）</li>
</ul>
</li>
<li><p>创建队列<br>队列：把任务放到队列里面，队列先进先出的原则，<br> 串行队列：顺序，一个一个执行(必须一个任务执行完了，才能从队列里面取出下一个任务)<strong>main queue</strong>用来更新UI<br> 并发队列：同时执行很多个任务（可以同时取出很多个任务，只要有线程去执行）<strong>global queue</strong><br>1&gt;获取全局并发队列:<br><code>dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</code><br>2&gt;获取系统主线程关联的串行队列<br><code>dispatch_queue_t queue = dispatch_get_main_queue();</code><br>3&gt;创建串行队列<br><code>dispatch_queue_t queue = dispatch_queue_create(&quot;mmmm.queue&quot;, DISPATCH_QUEUE_SERIAL);</code><br>4&gt;创建并发队列<br><code>dispatch_queue_t queue = dispatch_queue_create(&quot;mmmm.queue&quot;, DISPATCH_QUEUE_CONCURRENT);</code></p>
</li>
<li><p>同步：dispatch_sync(dispatch_queue_t, dispatch_block_t block);<br>异步：dispatch_async(dispatch_queue_t, dispatch_block_t block);<br>同步和异步的区别：<br>同步：在当前线程中执行,不具备开启新线程的能力<br>异步：在另一条新线程中执行，具备开启新线程的能力</p>
</li>
<li><p>使用GCD下载图片</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        <span class="comment">//耗时操作</span></span><br><span class="line">        <span class="comment">//1.url,确定一个网络上的资源文件路径</span></span><br><span class="line">        <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://p18.qhimg.com/t0144d6a0802f22be4f.jpg"</span>];</span><br><span class="line">        <span class="comment">//2.通过URL下载对应的网络资源，网络资源传输的都是二进制</span></span><br><span class="line">        <span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfFile:url];</span><br><span class="line">        <span class="comment">//3.把二进制转成图片</span></span><br><span class="line">        <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithData:data];</span><br><span class="line">        <span class="comment">//4.更新UI，在主线程-&gt;直接把主线程添加到主队列，就会在主队列执行</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">            <span class="keyword">self</span><span class="variable">.iconView</span><span class="variable">.image</span> = image;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>多次执行的任务<br>控制的代码块执行了5次。<br>` dispatch_apply(5, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^(size_t time){</p>
<pre><code>NSLog(@&quot;==执行【%lu次】==%@&quot;,time,[NSThread currentThread]);
</code></pre><p>}`</p>
</li>
<li><p>只执行一次的任务<br>`static dispatch_once_t oneceToken;<br> dispatch_once(&amp;oneceToken,^{</p>
<pre><code>NSLog(@&quot;==执行代码块==&quot;);
//线程暂停3秒
[NSThread sleepForTimeInterval:3];
</code></pre><p> });`<br>dispatch_once_t控制函数只执行一次</p>
</li>
</ol>
<h1 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h1><p>进入后台，系统会自动回调系统程序委托的applicationDidEnterBackground：方法。所有应用需要做：  </p>
<pre><code>- 释放所有可以释放的内存  
- 保存用户数据或状态信息，所有没写入磁盘的文件或信息，在进入后台之前，都应该写入磁盘，因为程序可能在后台被杀死。
</code></pre><ol>
<li>进入后台时释放内存<br>如果应用没有启用ARC机制，程序需要在进入后台是，将那些需要释放的资源的引用计数变为0，从而让系统回收这些资源，当应用转入前台，系统需要重新恢复这些资源。<br>如果应用启用了ARC机制，程序只要在应用进入后台时，将应用那些需要释放的资源的变量赋值为nil即可。当应用转入前台是，系统需要重新恢复这些资源。</li>
<li>进入后台时保存状态  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用NSUserDefault读取系统已经保存的积分</span></span><br><span class="line">   NSNumber* scoreNumber;</span><br><span class="line">   <span class="keyword">if</span> ((scoreNumber = [[NSUserDefaults standardUserDefaults]<span class="string">setInteger:</span>score <span class="string">forKey:</span>@<span class="string">"score"</span>])) &#123;</span><br><span class="line">       score = scoreNumber.integerValue;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>请求更多后台时间<br>为了请求更多后台时间，应该使用如下步骤：<ul>
<li>调用UIApplication对象的beginBackgroundTaskWithExpirationHandler:方法请求获取更多的后台执行时间。</li>
<li>调用dispatch_async()方法将指定代码块提交给后台执行</li>
<li>后台任务执行完成是，调用UIApplication对象的endBackgroundTask:方法结束后台任务。</li>
</ul>
</li>
</ol>
<h1 id="使用NSOperation与NSOperationQueue实现多线程"><a href="#使用NSOperation与NSOperationQueue实现多线程" class="headerlink" title="使用NSOperation与NSOperationQueue实现多线程"></a>使用NSOperation与NSOperationQueue实现多线程</h1><p>使用步骤：  </p>
<pre><code>- 创建NSOperationQueue队列，并为该队列设置相关属性。  
- 创建NSOperation子类的对象，并将该对象提交给NSOperationQueue队列，该队列将会按顺序启动每个NSOperation。   
</code></pre><p>MaxConcurrentOperationCount    设置最大并发线程数。</p>
<ol>
<li>使用NSblockOperation下载图片<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建NSBlock</span></span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *operation = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="comment">//从网络获取数据</span></span><br><span class="line">        <span class="built_in">NSData</span> *data = [[<span class="built_in">NSData</span> alloc]initWithContentsOfURL:[<span class="built_in">NSURL</span> URLWithString:url]];</span><br><span class="line">       <span class="comment">//将网络数据初始化为UIImage对象</span></span><br><span class="line">       <span class="built_in">UIImage</span> *image = [[<span class="built_in">UIImage</span> alloc]initWithData:data];</span><br><span class="line">         <span class="keyword">if</span>(image!= <span class="literal">nil</span>)&#123;</span><br><span class="line">            <span class="comment">//在主线程中updateUI：方法</span></span><br><span class="line">             [<span class="keyword">self</span> performSelectorOnMainThread:<span class="keyword">@selector</span>(updateUI:)withObject:image waitUntilDone:<span class="literal">YES</span>];</span><br><span class="line">         &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"下载图片出现错误"</span>);           </span><br><span class="line">        &#125;];</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>定义NSOperation子类<br>创建NSOperation的子类需要重写一个方法：-（void）main，该方法将作为NSOpQueue完成任务。</li>
</ol>
<h1 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h1><ol>
<li>什么是多线程<br>进程：是指在系统中正在运行的一个应用程序。1个进程要想执行任务，必须得有线程。（一个进程至少要有一个线程）特征：独立性，动态性，并发性。<br>线程：是进程的基本执行单元，一个进程（程序）的所有任务都在线程中执行。当一个程序运行时，内部可能包含了多个顺序执行流，每个顺序执行流就是一个线程的。<br>多线程：在一个进程中可以开启多个线程，每条线程可以并发（同时）执行不同的任务。<br>多线程编程的优点：  <ul>
<li>进程间不能共享内存，但线程之间共享内存非常容易</li>
<li>系统创建进程需要为该进程重新分配系统资源，但创建线程则代价小得多，因此使用多线程来实现多任务并发比多进程的效率高。</li>
<li>iOS提供了多种多线程实现方式，从而简化了iOS的多线程编程。<br>参考：<a href="http://1108038.blog.51cto.com/1098038/420330" target="_blank" rel="external">http://1108038.blog.51cto.com/1098038/420330</a><br>进程间通信—&gt;管道(pipe)、信号(signal)、消息队列、共享内存、信号量、套接字；<br>线程间通信—&gt;信号量、消息、事件event</li>
</ul>
</li>
<li>iOS中如何实现多线程<ul>
<li>pthread（一套通用的多线程API，使用难度大 <strong>C语言（底层）</strong>）程序员管理，几乎不用<br><code>#include &lt;pthread.h&gt;</code></li>
<li>NSThread（面向对象，简单易用，可直接操作多线程对象,<strong>OC</strong>），偶尔使用</li>
<li>GCD（旨在替代NSThread等线程技术，充分利用设备的多核，<strong>C语言</strong>）自动管理，经常使用</li>
<li>NSOperation（基于GCD，比GCD多了一些简单实用的功能，<strong>OC</strong>）自动管理，经常使用.</li>
</ul>
</li>
<li>线程间通讯的方法<br>控制器在子线程发送请求给服务器<br>服务器在主线程刷新UI界面到控制器<br><img src="http://7xr8q7.com1.z0.glb.clouddn.com/%E7%BA%BF%E7%A8%8B%E9%97%B4%E9%80%9A%E8%AE%AF.png" alt=""><br>还可以使用GCD，主线程和子线程的通信。<br> <code>dispath_async(dispatch_get_main_queue(),^{
 });</code> </li>
<li><p>网络图片处理问题中怎么解决一个相同的网络地址重复请求的问题？<br><img src="http://7xr8q7.com1.z0.glb.clouddn.com/%E8%87%AA%E5%AE%9A%E4%B9%89NSOperation%E4%B8%8B%E8%BD%BD%E5%9B%BE%E7%89%87.png" alt=""><br>利用字典（图片地址为key，下载操作为value）</p>
</li>
<li><p>多线程安全的几种解决办法及多线程安全怎么控制？<br>线程安全的概念: 就是在多个线程同时执行的时候，能够保证资源信息的准确性.</p>
<ul>
<li>苹果约定，<strong>所有程序的更新UI都在主线程进行</strong>，也就不会出现多个线程同时改变一个资源。在主线程更新UI，有什么好处？只在主线程更新UI，就不会出现多个线程同时改变同一个UI控件;主线程的优先级最高。也就意味UI的更新优先级高。 会让用户感觉很流畅    .</li>
<li>如果要防止资源抢夺，得用synchronized进行加锁保护.<br>线程同步：多条线程按顺序的执行任务（互斥锁）互斥锁使用格式<br><code>@synchronized(锁对象){
//需要锁定的代码
}</code></li>
<li>如果异步操作要保证线程安全等问题, 尽量使用GCD(有些函数默认就是安全的)</li>
</ul>
</li>
<li><p>GCD内部怎么实现的<br>1&gt; iOS和OS X的核心是XNU内核，GCD是基于XNU内核实现的<br>2&gt; GCD的API全部在libdispatch库中<br>3&gt; GCD的底层实现主要有Dispatch Queue和Dispatch Source</p>
<ul>
<li>Dispatch Queue ：管理block(操作)</li>
<li>Dispatch Source ：处理事件(比如线程间的通讯)<br>补充：GCD：Grand Central Dispatch “牛逼的中枢调度器”，自动利用更多CPU内核，自动管理线程的生命周期（创建线程，调度任务，销毁线程).使用2个步骤：  </li>
<li>定制任务（执行什么操作）用block来封装任务  </li>
<li>将任务添加到队列中（自动将队列中的任务取出，放到对应的线程中执行）（先进先出，后进后出）</li>
</ul>
</li>
<li><p>GCD和NSoperation区别<br>1&gt;GCD是纯C语言的API，NSOperationQueue是基于GCD的OC版本封装<br>2&gt;GCD只支持FIFO的队列，NSOperationQueue可以很方便地调整执行顺序、设置最大并发数量<br>3&gt;NSOperationQueue可以在轻松在Operation间设置依赖关系，而GCD需要写很多的代码才能实现<br>4&gt;NSOperationQueue支持KVO，可以监测operation是否正在执行（isExecuted）、是否结束（isFinished），是否取消（isCanceld）<br>5&gt;GCD的执行速度比NSOperationQueue快<br>任务之间不太互相依赖：GCD<br>任务之间有依赖(或者要监听任务的执行情况)：NSOperationQueue</p>
</li>
<li>Socket的实现原理以及Socket是如何实现通信的？<br>Socket：称之为套接字，是一种用于网络传输的“工具”。<br>socket的实现原理：是基于TCP/UDP的（TCP：传输控制协议，是一种面向连接的，安全的，基于IP传输层的协议，三次握手。例如：XMPP等网络聊天）（UDP：传输控制协议，是一种面向连接的，不安全的，基于IP传输层的协议，特点：快，只管发，不管收到没有。例如：游戏,QQ视频，红蜘蛛）</li>
<li><p>http协议的实现<br>HTTP：是一种超文本协议，定义了网络传输的格式（短连接）<br>如果利用HTTP做聊天，每次都要重新创建连接，因为HTTP是短连接，一次回话后就断开了，如果利用HTTP做聊天，如果聊天特别频繁，会不断的创建连接，消耗资源，性能不好，服务端不会主动给客户端发送请求。      </p>
</li>
<li><p>runloop定时源和输入源?<br>1&gt;你创建的程序不需要显示的创建run loop；每个线程，包括程序的主线程（main thread）都有与之相应的run loop对象, 主线程会自行创建并运行run loop<br>2&gt;Run loop处理的输入事件有两种不同的来源：输入源（input source）（异步）（处理其他线程回到主线程的消息）和定时源（timer source）（同步）（定时检查界面上有没有点击事件，检查主线程的事件）<br>3&gt;输入源传递异步消息，通常来自于其他线程或者程序。定时源则传递同步消息，在特定时间或者一定的时间间隔发生<br><img src="http://7xr8q7.com1.z0.glb.clouddn.com/runloop.png" alt=""></p>
</li>
<li>NSRunLoop的实现机制,及在多线程中如何使用<br>NSRunLoop是IOS消息机制的处理模式.<blockquote>
<p>1.NSRunLoop的主要作用：控制NSRunLoop里面线程的执行和休眠，在有事情做的时候使当前NSRunLoop控制的线程工作，没有事情做让当前NSRunLoop的控制的线程休眠。<br>2.NSRunLoop 就是一直在循环检测，从线程start到线程end，检测inputsource(如点击，双击等操作)异步事件，检测timesource同步事件，检测到输入源会执行处理函数，首先会产生通知，corefunction向线程添加runloop observers来监听事件，意在监听事件发生时来做处理。<br>3.runloopmode是一个集合，包括监听：事件源，定时器，以及需通知的runloop observers</p>
</blockquote>
</li>
</ol>
<blockquote>
<ol>
<li>只有在为你的程序创建次线程的时候，才需要运行run loop。对于程序的主线程而言，run loop是关键部分。Cocoa提供了运行主线程run loop的代码同时也会自动运行run loop。IOS程序UIApplication中的run方法在程序正常启动的时候就会启动run loop。如果你使用xcode提供的模板创建的程序，那你永远不需要自己去启动run loop</li>
<li>在多线程中，你需要判断是否需要run loop。如果需要run loop，那么你要负责配置run loop并启动。你不需要在任何情况下都去启动run loop。比如，你使用线程去处理一个预先定义好的耗时极长的任务时，你就可以毋需启动run loop。Run loop只在你要和线程有交互时才需要</li>
</ol>
</blockquote>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2016/03/04/iOS中的多线程网络/">iOS中的多线程网络</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 向阳 的个人博客">向阳</a></p>
        <p><span>发布时间:</span>2016年03月04日 - 21时31分</p>
        <p><span>最后更新:</span>2016年07月16日 - 09时03分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2016/03/04/iOS中的多线程网络/" title="iOS中的多线程网络">http://peilinghui.com/2016/03/04/iOS中的多线程网络/</a>
            <span class="copy-path" data-clipboard-text="原文: http://peilinghui.com/2016/03/04/iOS中的多线程网络/　　作者: 向阳" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2016/03/05/iOS中的数据存储/">
                    iOS中的数据存储
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2016/03/01/计算机基础知识/">
                    计算机基础知识总结
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#多线程网络"><span class="toc-number">1.</span> <span class="toc-text">多线程网络</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NSthread"><span class="toc-number">1.1.</span> <span class="toc-text">NSthread</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#线程同步与线程通信"><span class="toc-number">1.1.1.</span> <span class="toc-text">线程同步与线程通信</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GCD"><span class="toc-number">2.</span> <span class="toc-text">GCD</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#后台运行"><span class="toc-number">3.</span> <span class="toc-text">后台运行</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#使用NSOperation与NSOperationQueue实现多线程"><span class="toc-number">4.</span> <span class="toc-text">使用NSOperation与NSOperationQueue实现多线程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#面试题"><span class="toc-number">5.</span> <span class="toc-text">面试题</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>




    <div class="share">
    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
    <a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
    <a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
    </div>
    <script>
        window._bd_share_config={
            "common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
    </script>
</div>



    
      <div class="duoshuo" id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2016/03/04/iOS中的多线程网络/" data-title="iOS中的多线程网络" data-url="http://peilinghui.com/2016/03/04/iOS中的多线程网络/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"peilinghui"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    <!-- 多说公共JS代码 end -->
</div>

    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2016/03/05/iOS中的数据存储/" title="上一篇: iOS中的数据存储">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2016/03/01/计算机基础知识/" title="下一篇: 计算机基础知识总结">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/03/02/iOS中的加密实现/">iOS中的加密实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/13/JavaScript高级程序设计读书笔记/">JavaScript高级程序设计读书笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/20/二维码/">二维码</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/05/深入学习Runtime/">深入学习Runtime</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/05/深入学习GCD/">深入学习GCD</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/02/TableView的一些事/">TableView的一些事</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/02/iOS中页面传值和页面跳转/">iOS中页面传值和页面跳转 </a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/29/ReactiveCocoa学习笔记/">ReactiveCocoa学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/14/iOS调试技巧/">iOS调试技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/14/iOS网络编程/">iOS网络编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/03/effective objective-c 2.0读书笔记/">effective objective-c 2.0读书笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/01/Objective-C高级编程读书笔记/">Objective-C高级编程读书笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/27/iOS面试题/">iOS面试题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/14/ViewController的生命周期/">ViewController的生命周期</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/06/研究SDWebImage框架/">研究SDWebImage框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/05/研究AFNetworking框架/">研究AFNetworking框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/05/iOS中的数据存储/">iOS中的数据存储</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/04/iOS中的多线程网络/">iOS中的多线程网络</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/计算机基础知识/">计算机基础知识总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/01/iOS面试题总结/">iOS面试题总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/25/git学习/">git学习笔记</a></li></ul>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2017 向阳
            </div>
            <div class="footer-right">
	     欢迎光临小站
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" >本站到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.1.22/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>


<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>